{% extends 'base.html' %}

{% block title %}Dashboard - ParentPlanner{% endblock %}

{% block extra_head %}
<!-- Optimised dashboard assets -->
{% load static %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=3">
<link rel="stylesheet" href="{% static 'css/dashboard-scroll.css' %}">
<script src="{% static 'js/clean-swipe.js' %}" defer></script>
<script src="{% static 'js/color_picker.js' %}" defer></script>
<script src="{% static 'js/expandable-cards.js' %}" defer></script>

<style>
/* Color Picker Styling */
.color-grid-widget {
    margin: 0.5rem 0;
}

.color-dots-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem;
    padding: 1rem;
    background-color: #f9fafb;
    border: 2px solid #4F46E5;
    max-width: 250px;
}

.color-dot {
    width: 2rem;
    height: 2rem;
    border: 2px solid #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    justify-self: center;
    border-radius: 50%;
}

.color-dot:hover {
    transform: scale(1.1);
    border-color: #111827;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.color-dot.selected {
    border-color: #4f46e5;
    transform: scale(1.15);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3), 0 2px 8px rgba(0, 0, 0, 0.3);
    border-width: 3px;
}

/* Line clamp utilities for text truncation */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.expanded-content {
    display: block !important;
    -webkit-line-clamp: unset !important;
    -webkit-box-orient: unset !important;
    overflow: visible !important;
}

/* Expandable card styles */
.card-content {
    transition: all 0.3s ease;
}

.expanded {
    transition: all 0.3s ease;
}

.expanded-details {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.color-dot-small {
    border-radius: 50%;
    transition: all 0.2s ease;
    border: 2px solid #666;
}

.color-dot-small:hover {
    transform: scale(1.1);
    border-color: #111;
}

.color-dot-small.selected {
    border-color: #4f46e5;
    transform: scale(1.15);
    border-width: 3px;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
}

.force-visible {
    display: block !important;
    visibility: visible !important;
}

/* Expandable Cards Styles */
.expanded {
    transition: all 0.3s ease;
}

.expanded-content {
    white-space: normal !important;
    overflow: visible !important;
    display: block !important;
}

.expanded-details {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
}

.expanded .expanded-details {
    display: block !important;
}

.card-actions {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-content {
    position: relative;
}

/* Ensure expanded cards are above others */
.expanded {
    position: relative;
    z-index: 10;
}

/* Desktop layout height constraints */
@media (min-width: 1024px) {
    .dashboard-section {
        max-height: calc(100vh - 80px);
        overflow: hidden;
    }
    
    .dashboard-section .flex-1 {
        max-height: calc(100% - 80px);
        overflow-y: auto;
    }
}

@media (min-width: 1280px) {
    .dashboard-section {
        max-height: calc(100vh - 60px);
    }
    
    .dashboard-section .flex-1 {
        max-height: calc(100% - 70px);
    }
}
</style>

<script>
function toggleEntryDetails(card) {
    const details = card.querySelector('.entry-details');
    if (details) details.classList.toggle('hidden');
}

function toggleNoteDetails(card) {
    const details = card.querySelector('.note-details');
    if (details) details.classList.toggle('hidden');
}

function collapseAllEntries() {
    document.querySelectorAll('.entry-details').forEach(d => d.classList.add('hidden'));
}

function collapseAllNotes() {
    document.querySelectorAll('.note-details').forEach(d => d.classList.add('hidden'));
}
    let selectedChildId = null;
    
    function toggleNotesForm() {
        const mobileForm = document.getElementById('notesFormMobile');
        const desktopForm = document.getElementById('notesFormDesktop');
        if (mobileForm) mobileForm.classList.toggle('hidden');
        if (desktopForm) desktopForm.classList.toggle('hidden');
    }
    
        // Modal functions
    function openAddChildModal() {
        document.getElementById('addChildModal').classList.remove('hidden');
    }

    function closeAddChildModal() {
        document.getElementById('addChildModal').classList.add('hidden');
    }

    function openAddEntryModal() {
        document.getElementById('addEntryModal').classList.remove('hidden');
        // Initialize entry type field toggling for this modal
        setTimeout(() => {
            initializeEntryTypeToggling();
        }, 100);
    }

    function closeAddEntryModal() {
        document.getElementById('addEntryModal').classList.add('hidden');
    }

    function openAddNoteModal() {
        document.getElementById('addNoteModal').classList.remove('hidden');
    }

    function closeAddNoteModal() {
        document.getElementById('addNoteModal').classList.add('hidden');
    }

    function openAddEventModal(childId) {
        // If a childId is provided, pre-select that child
        if (childId) {
            document.getElementById('selectedChildInputModal').value = childId;
            // Also select the child in the form dropdown if it exists
            const childSelect = document.querySelector('#addEntryModal select[name="child"]');
            if (childSelect) {
                childSelect.value = childId;
            }
        }
        // Pre-select event entry type
        const entryTypeSelect = document.querySelector('#addEntryModal select[name="entry_type"]');
        if (entryTypeSelect) {
            entryTypeSelect.value = 'event';
            // Trigger change event to show relevant fields
            entryTypeSelect.dispatchEvent(new Event('change'));
        }
        document.getElementById('addEntryModal').classList.remove('hidden');
    }

    function openAddTaskModal(childId) {
        // If a childId is provided, pre-select that child
        if (childId) {
            document.getElementById('selectedChildInputModal').value = childId;
            // Also select the child in the form dropdown if it exists
            const childSelect = document.querySelector('#addEntryModal select[name="child"]');
            if (childSelect) {
                childSelect.value = childId;
            }
        }
        // Pre-select task entry type
        const entryTypeSelect = document.querySelector('#addEntryModal select[name="entry_type"]');
        if (entryTypeSelect) {
            entryTypeSelect.value = 'task';
            // Trigger change event to show relevant fields
            entryTypeSelect.dispatchEvent(new Event('change'));
        }
        document.getElementById('addEntryModal').classList.remove('hidden');
    }

    function closeEditChildModal() {
        document.getElementById('editChildModal').classList.add('hidden');
    }

    function selectEditColorDot(element) {
        // Remove selected class from all dots
        const allDots = document.querySelectorAll('#editChildModal .color-dot');
        allDots.forEach(dot => dot.classList.remove('selected'));
        
        // Add selected class to clicked dot
        element.classList.add('selected');
        
        // Update hidden input
        document.getElementById('edit_child_colour').value = element.getAttribute('data-color');
    }

    function deleteChild() {
        if (confirm('Are you sure you want to delete this child? This action cannot be undone.')) {
            const form = document.getElementById('editChildForm');
            const deleteForm = document.createElement('form');
            deleteForm.method = 'post';
            deleteForm.action = form.action.replace('/edit_child/', '/delete_child/');
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            deleteForm.appendChild(csrfToken);
            document.body.appendChild(deleteForm);
            deleteForm.submit();
        }
    }



    // Close modals when clicking outside or pressing escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAddChildModal();
            closeAddEntryModal();
            closeAddNoteModal();
            closeEditChildModal();
            closeEditEntryModal();
            closeEditNoteModal();
        }
    });

    function toggleChildForm(isMobile = false) {
        const desktopForm = document.getElementById('childFormDesktop');
        const mobileForm = document.getElementById('childFormMobile');
        if (isMobile && mobileForm) mobileForm.classList.toggle('hidden');
        if (!isMobile && desktopForm) desktopForm.classList.toggle('hidden');
    }

    function selectChildColor(colorDot, childId) {
        // Remove selected class from all color dots for this child
        const parentForm = colorDot.closest('form');
        if (parentForm) {
            parentForm.querySelectorAll('.color-dot-small').forEach(dot => {
                dot.classList.remove('selected');
                dot.style.borderWidth = '1px';
                dot.style.borderColor = '#666';
            });
        }
        
        // Add selected class to clicked dot
        colorDot.classList.add('selected');
        colorDot.style.borderWidth = '3px';
        colorDot.style.borderColor = '#4F46E5';
        
        // Update hidden input
        const colorInput = document.getElementById(`childColor${childId}`);
        if (colorInput) {
            colorInput.value = colorDot.dataset.color;
        }
    }

    function toggleEntryForm(isMobile = false) {
        const mobileForm = document.getElementById('entryFormMobile');
        const desktopForm = document.getElementById('entryFormDesktop');
        if (mobileForm) mobileForm.classList.toggle('hidden');
        if (desktopForm) desktopForm.classList.toggle('hidden');
        
        // Update child field visibility and selection based on current state
        updateChildFieldsInForms();
    }
    
    function updateChildFieldsInForms() {
        // Always show child dropdown fields and auto-select for both entry and notes forms
        const childSelects = document.querySelectorAll('select[name="child"]');
        childSelects.forEach(select => {
            if (selectedChildId && selectedChildId !== 'all') {
                select.value = selectedChildId;
            } else {
                select.selectedIndex = 0;
            }
        });
    }
    
    function selectChild(childId, childName) {
        selectedChildId = childId;
        
        // Update child selection in forms
        const childSelects = document.querySelectorAll('select[name="child"]');
        childSelects.forEach(select => {
            select.value = childId;
        });
        
        // Update child fields in forms based on selection
        updateChildFieldsInForms();
        
        // Filter entries and notes to show only selected child's content
        filterContentByChild(childId);
        
        // Update UI to show selected child
        updateSelectedChildUI(childId, childName);
    }

    // Initialize color selection when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Set up color selection for each child edit form
        const childCards = document.querySelectorAll('.child-card');
        childCards.forEach(card => {
            const childId = card.dataset.childId;
            const colorInput = document.getElementById(`childColor${childId}`);
            if (colorInput) {
                const currentColor = colorInput.value;
                const colorDot = card.querySelector(`[data-color="${currentColor}"]`);
                if (colorDot) {
                    colorDot.classList.add('selected');
                    colorDot.style.borderWidth = '3px';
                    colorDot.style.borderColor = '#4F46E5';
                }
            }
        });
        
        // Initialize child fields in forms on page load
        updateChildFieldsInForms();
    });

    function toggleChildEdit(childId) {
        // Find forms for both mobile and desktop with correct IDs
        const mobileForm = document.getElementById(`childEdit${childId}Mobile`);
        const desktopForm = document.getElementById(`childEdit${childId}Desktop`);
        
        // Get child name for selection
        const childCard = document.querySelector(`[data-child-id="${childId}"]`);
        const childNameElement = childCard ? childCard.querySelector('h3') : null;
        const childName = childNameElement ? childNameElement.textContent.trim() : `Child ${childId}`;
        
        // Select the child first (filter entries and update UI)
        selectChild(childId, childName);
        
        // Toggle the forms exactly like other forms
        if (mobileForm) mobileForm.classList.toggle('hidden');
        if (desktopForm) desktopForm.classList.toggle('hidden');
    }
    
    // Filter only entries and notes, NOT child cards
    function filterEntriesOnly(childId) {
        const entries = document.querySelectorAll('[data-child-id]');
        entries.forEach(entry => {
            // Skip child cards - only filter actual content
            if (!entry.classList.contains('child-card')) {
                if (entry.dataset.childId == childId) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            }
        });
    }
    
    // Update only headers, not child card states
    function updateHeadersOnly(childId, childName) {
        const headers = document.querySelectorAll('.child-header-text');
        headers.forEach(header => {
            header.textContent = childName + "'s Tasks & Events";
        });
        
        const noteHeaders = document.querySelectorAll('.notes-header-text');
        noteHeaders.forEach(header => {
            header.textContent = childName + "'s Notes";
        });
    }
    
    function showAllChildren() {
        selectedChildId = null;
        
        // Hide all edit forms first (close any open child edit forms)
        const allEditFormsMobile = document.querySelectorAll('[id^="childEdit"][id$="Mobile"]');
        const allEditFormsDesktop = document.querySelectorAll('[id^="childEdit"][id$="Desktop"]');
        allEditFormsMobile.forEach(form => form.classList.add('hidden'));
        allEditFormsDesktop.forEach(form => form.classList.add('hidden'));
        
        // Show all content entries (but child cards should always be visible)
        const entries = document.querySelectorAll('[data-child-id]');
        entries.forEach(entry => {
            entry.style.display = 'block';
        });
        
        // Reset child selection in forms
        const childSelects = document.querySelectorAll('select[name="child"]');
        childSelects.forEach(select => {
            select.selectedIndex = 0;
        });
        
        // Update child fields in forms to show dropdowns
        updateChildFieldsInForms();
        
        // Reset UI
        updateSelectedChildUI(null, 'All Children');
    }
    
    function filterContentByChild(childId) {
        const entries = document.querySelectorAll('[data-child-id]');
        entries.forEach(entry => {
            // Skip child cards - only filter actual content entries
            if (!entry.classList.contains('child-card')) {
                if (entry.dataset.childId == childId) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            }
        });
    }
    
    function updateSelectedChildUI(childId, childName) {
        // Update header text
        const headers = document.querySelectorAll('.child-header-text');
        headers.forEach(header => {
            header.textContent = childName + (childId ? "'s Tasks & Events" : " Overview");
        });
        
        const noteHeaders = document.querySelectorAll('.notes-header-text');
        noteHeaders.forEach(header => {
            header.textContent = childId ? childName + "'s Notes" : "All Notes";
        });
        
        // Update child cards active state
        const childCards = document.querySelectorAll('.child-card');
        childCards.forEach(card => {
            if (card.dataset.childId == childId) {
                card.classList.add('border-primary', 'bg-blue-50');
                card.classList.remove('border-gray-300');
            } else {
                card.classList.remove('border-primary', 'bg-blue-50');
                card.classList.add('border-gray-300');
            }
        });
    }

    function closeEditEntryModal() {
        const modal = document.getElementById('editEntryModal');
        modal.classList.add('hidden');
    }

    function closeEditNoteModal() {
        const modal = document.getElementById('editNoteModal');
        modal.classList.add('hidden');
    }

    function deleteEntry() {
        const form = document.getElementById('editEntryForm');
        const entryTitle = document.getElementById('edit_entry_title').value;
        
        if (confirm(`Are you sure you want to delete "${entryTitle}"? This action cannot be undone.`)) {
            const deleteForm = document.createElement('form');
            deleteForm.method = 'post';
            deleteForm.action = form.action.replace('/edit_entry/', '/delete_entry/');
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            deleteForm.appendChild(csrfToken);
            document.body.appendChild(deleteForm);
            deleteForm.submit();
        }
    }

    function deleteNote() {
        const form = document.getElementById('editNoteForm');
        const noteTitle = document.getElementById('edit_note_title').value;
        
        if (confirm(`Are you sure you want to delete "${noteTitle}"? This action cannot be undone.`)) {
            const deleteForm = document.createElement('form');
            deleteForm.method = 'post';
            deleteForm.action = form.action.replace('/edit_note/', '/delete_note/');
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            deleteForm.appendChild(csrfToken);
            document.body.appendChild(deleteForm);
            deleteForm.submit();
        }
    }

    // Handle URL parameters for opening modals
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const openModal = urlParams.get('open');
        const childId = urlParams.get('child');
        
        if (openModal === 'addEvent') {
            openAddEventModal(childId);
        } else if (openModal === 'addTask') {
            openAddTaskModal(childId);
        } else if (openModal === 'addNote') {
            openAddNoteModal();
        }
        
        // Clean up the URL after opening modal
        if (openModal) {
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
        
        // Initialize entry type field toggling
        initializeEntryTypeToggling();
    });
    
    // Entry type field toggling functionality
    function initializeEntryTypeToggling() {
        const entryTypeSelects = document.querySelectorAll('select[name="entry_type"]');
        entryTypeSelects.forEach(select => {
            // Set initial state
            toggleEntryTypeFields(select.value, select);
            
            // Add change event listener
            select.addEventListener('change', function() {
                toggleEntryTypeFields(this.value, this);
            });
        });
    }
    
    function toggleEntryTypeFields(entryType, selectElement) {
        // Find the closest form or modal container
        const container = selectElement.closest('form') || selectElement.closest('.modal') || document;
        
        // Hide all entry-type specific fields in this container
        const allEntryFields = container.querySelectorAll('.entry-type-fields');
        allEntryFields.forEach(field => field.classList.add('hidden'));
        
        // Show relevant fields based on entry type
        if (entryType === 'event') {
            const eventFields = container.querySelector('#eventFields');
            if (eventFields) eventFields.classList.remove('hidden');
        } else if (entryType === 'task') {
            const taskFields = container.querySelector('#taskFields');
            if (taskFields) taskFields.classList.remove('hidden');
        }
        // Note: No additional fields needed for 'note' type since notes use separate form
        
        console.log('Entry type changed to:', entryType); // Debug log
    }
</script>
{% endblock %}

{% block content %}
<!-- Live Region for Screen Reader Announcements -->
<div id="live-region" class="live-region" aria-live="polite" aria-atomic="true"></div>

<!-- Main Dashboard Container -->
<div class="bg-gray-50 pb-4">
    {% if children_count == 0 %}
        <!-- No Children State -->
        <div class="flex items-center justify-center py-16">
            <div class="text-center max-w-md mx-auto p-6">
                <div class="w-24 h-24 mx-auto mb-6 bg-primary-light border-4 border-primary flex items-center justify-center rounded-full">
                    <i class="fas fa-users text-2xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">Welcome to ParentPlanner!</h2>
                <p class="text-gray-600 mb-6">Start by adding your first child to begin planning and organizing.</p>
                <button onclick="openAddChildModal()" class="bg-primary hover:bg-primary-dark text-white font-medium px-6 py-3 border-2 border-primary transition-all duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Your First Child
                </button>
            </div>
        </div>
    {% else %}
        <!-- Dashboard with Children -->
        <div class="w-full px-4 py-6 lg:py-2 lg:h-screen lg:flex lg:flex-col xl:h-screen xl:overflow-hidden">

            <!-- Dashboard Grid -->
            <!-- Mobile Swipe Navigation (mobile only) -->
            <div class="w-full max-w-7xl mx-auto block lg:hidden">
                <!-- Mobile Navigation Indicators -->
                <div class="flex justify-center mb-4 space-x-2" role="tablist" aria-label="Dashboard sections">
                    <button class="nav-indicator w-3 h-3 rounded-full bg-gray-300 transition-colors duration-200" 
                            data-section="0" 
                            role="tab" 
                            aria-controls="children-section"
                            aria-label="Children section"
                            tabindex="-1"></button>
                    <button class="nav-indicator w-3 h-3 rounded-full bg-primary transition-colors duration-200" 
                            data-section="1" 
                            role="tab" 
                            aria-controls="events-section"
                            aria-label="Events section"
                            aria-selected="true"
                            tabindex="0"></button>
                    <button class="nav-indicator w-3 h-3 rounded-full bg-gray-300 transition-colors duration-200" 
                            data-section="2" 
                            role="tab" 
                            aria-controls="tasks-section"
                            aria-label="Tasks section"
                            tabindex="-1"></button>
                    <button class="nav-indicator w-3 h-3 rounded-full bg-gray-300 transition-colors duration-200" 
                            data-section="3" 
                            role="tab" 
                            aria-controls="notes-section"
                            aria-label="Notes section"
                            tabindex="-1"></button>
                </div>
                
                <!-- Swipeable Container -->
                <div id="swipeContainer" class="relative overflow-hidden h-[500px]" role="tabpanel">
                    <div id="swipeContent" class="flex transition-transform duration-300 ease-out" style="transform: translateX(-100%);">
                        <!-- Children Section -->
                        <div id="children-section" class="w-full h-[500px] flex-shrink-0 px-2" role="tabpanel" aria-labelledby="children-section-heading">
                            {% include 'components/children_section.html' %}
                        </div>

                        <!-- Timeline Section (Events) -->
                        <div id="events-section" class="w-full h-[500px] flex-shrink-0 px-2" role="tabpanel" aria-labelledby="events-section-heading">
                            {% include 'components/timeline_section.html' %}
                        </div>

                        <!-- Tasks Section -->
                        <div id="tasks-section" class="w-full h-[500px] flex-shrink-0 px-2" role="tabpanel" aria-labelledby="tasks-section-heading">
                            {% include 'components/tasks_section.html' %}
                        </div>

                        <!-- Notes Section -->
                        <div id="notes-section" class="w-full h-[500px] flex-shrink-0 px-2" role="tabpanel" aria-labelledby="notes-section-heading">
                            {% include 'components/notes_section.html' %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop Grid (original layout) -->
<div class="w-full px-4 hidden lg:grid grid-cols-4 gap-3 lg:gap-6 lg:flex-1 lg:min-h-0 lg:max-h-[calc(100vh-80px)] xl:max-h-[calc(100vh-60px)] lg:overflow-hidden">
                <!-- Children Section -->
                <div class="w-full h-full min-h-0 max-h-full">
                    {% include 'components/children_section.html' %}
                </div>

                <!-- Timeline Section (Events) -->
                <div class="w-full h-full min-h-0 max-h-full">
                    {% include 'components/timeline_section.html' %}
                </div>

                <!-- Tasks Section -->
                <div class="w-full h-full min-h-0 max-h-full">
                    {% include 'components/tasks_section.html' %}
                </div>

                <!-- Notes Section -->
                <div class="w-full h-full min-h-0 max-h-full">
                    {% include 'components/notes_section.html' %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal Overlays -->
<!-- Add Child Modal -->
<div id="addChildModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center" onclick="closeAddChildModal()" role="dialog" aria-labelledby="add-child-modal-title" aria-modal="true">
    <div class="bg-white border-2 border-secondary w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="border-b-2 border-secondary bg-purple-50 px-4 py-3">
            <div class="flex items-center justify-between">
                <h2 id="add-child-modal-title" class="text-lg font-medium text-gray-900">Add New Child</h2>
                <button onclick="closeAddChildModal()" class="text-gray-500 hover:text-gray-700" aria-label="Close dialog">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        <div class="p-4">
            <form method="post" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="add_child" value="1">
                
                <div>
                    <label for="{{ child_form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Name <span class="text-red-500" aria-label="Required">*</span></label>
                    {{ child_form.name }}
                    {% if child_form.name.errors %}
                        <div class="text-red-500 text-sm mt-1" role="alert">{{ child_form.name.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ child_form.birth_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ child_form.birth_date.label }}</label>
                    {{ child_form.birth_date }}
                    {% if child_form.birth_date.help_text %}
                        <p class="text-xs text-gray-500 mt-1">{{ child_form.birth_date.help_text }}</p>
                    {% endif %}
                    {% if child_form.birth_date.errors %}
                        <div class="text-red-500 text-sm mt-1" role="alert">{{ child_form.birth_date.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ child_form.school.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">School</label>
                    {{ child_form.school }}
                    {% if child_form.school.errors %}
                        <div class="text-red-500 text-sm mt-1" role="alert">{{ child_form.school.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ child_form.year.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                    {{ child_form.year }}
                    {% if child_form.year.errors %}
                        <div class="text-red-500 text-sm mt-1" role="alert">{{ child_form.year.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ child_form.class_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                    {{ child_form.class_name }}
                    {% if child_form.class_name.errors %}
                        <div class="text-red-500 text-sm mt-1" role="alert">{{ child_form.class_name.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ child_form.colour.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Colour</label>
                    {{ child_form.colour }}
                    
                    <!-- Custom color grid -->
                    <div class="color-grid-widget mt-2" data-target="{{ child_form.colour.id_for_label }}">
                        <fieldset>
                            <legend class="sr-only">Choose a color for this child</legend>
                            <div class="color-dots-grid grid grid-cols-5 gap-2" role="radiogroup" aria-labelledby="{{ child_form.colour.id_for_label }}">
                                <div class="color-dot selected w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#FF6B6B"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #FF6B6B;"
                                     title="Coral Red"
                                     role="radio"
                                     aria-checked="true"
                                     aria-label="Coral Red"
                                     tabindex="0">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#4ECDC4"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #4ECDC4;"
                                     title="Turquoise"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Turquoise"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#0D6A80"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #0D6A80;"
                                     title="Sky Blue"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Sky Blue"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#96CEB4"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #96CEB4;"
                                     title="Mint Green"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Mint Green"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#D1D811"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #D1D811;"
                                     title="Sunny Yellow"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Sunny Yellow"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#DDA0DD"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #DDA0DD;"
                                     title="Plum Purple"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Plum Purple"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#AD6A0D"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #AD6A0D;"
                                     title="Peach Orange"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Peach Orange"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#8516EE"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #8516EE;"
                                     title="Light Blue"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Light Blue"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#0CEB0C"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #0CEB0C;"
                                     title="Pale Green"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Pale Green"
                                     tabindex="-1">
                                </div>
                                <div class="color-dot w-8 h-8 border-2 cursor-pointer" 
                                     data-color="#BE12E0"
                                     onclick="selectColorDot(this, '{{ child_form.colour.id_for_label }}')"
                                     style="background-color: #BE12E0;"
                                     title="Bright Pink"
                                     role="radio"
                                     aria-checked="false"
                                     aria-label="Bright Pink"
                                     tabindex="-1">
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    {% if child_form.colour.errors %}
                        <div class="text-red-500 text-sm mt-1" role="alert">{{ child_form.colour.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="bg-secondary hover:bg-purple-700 text-white font-medium py-2 px-4 border-2 border-secondary transition-all duration-200 tracking-wide">
                        Add Child
                    </button>
                    <button type="button" onclick="closeAddChildModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 border-2 border-gray-300 transition-all duration-200 tracking-wide">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Entry Modal -->
<div id="addEntryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center" onclick="closeAddEntryModal()">
    <div class="bg-white border-2 border-primary w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="border-b-2 border-primary bg-gray-50 px-4 py-3">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-medium text-gray-900">Add New Entry</h2>
                <button onclick="closeAddEntryModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-4">
            <form method="post" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="add_entry" value="1">
                <input type="hidden" id="selectedChildInputModal" name="selected_child" value="">
                
                <div>
                    <label for="{{ form.child.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Child</label>
                    {{ form.child }}
                </div>
                
                <div>
                    <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    {{ form.title }}
                </div>
                
                <!-- Hidden entry type field - automatically set by modal functions -->
                <div class="hidden">
                    {{ form.entry_type }}
                </div>
                
                <div>
                    <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    {{ form.category }}
                </div>
                
                <div>
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    {{ form.description }}
                </div>
                
                <!-- Entry-type specific fields -->
                <!-- Event Fields -->
                <div id="eventFields" class="entry-type-fields hidden">
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label for="{{ form.event_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.event_date.label }}</label>
                            {{ form.event_date }}
                            {% if form.event_date.help_text %}
                                <p class="text-xs text-gray-500 mt-1">{{ form.event_date.help_text }}</p>
                            {% endif %}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="{{ form.event_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.event_start_time.label }}</label>
                                {{ form.event_start_time }}
                                {% if form.event_start_time.help_text %}
                                    <p class="text-xs text-gray-500 mt-1">{{ form.event_start_time.help_text }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.event_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.event_end_time.label }}</label>
                                {{ form.event_end_time }}
                                {% if form.event_end_time.help_text %}
                                    <p class="text-xs text-gray-500 mt-1">{{ form.event_end_time.help_text }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            {{ form.location }}
                        </div>
                    </div>
                </div>
                
                <!-- Task Fields -->
                <div id="taskFields" class="entry-type-fields hidden">
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label for="{{ form.priority.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            {{ form.priority }}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="{{ form.task_due_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.task_due_date.label }}</label>
                                {{ form.task_due_date }}
                                {% if form.task_due_date.help_text %}
                                    <p class="text-xs text-gray-500 mt-1">{{ form.task_due_date.help_text }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.task_due_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.task_due_time.label }}</label>
                                {{ form.task_due_time }}
                                {% if form.task_due_time.help_text %}
                                    <p class="text-xs text-gray-500 mt-1">{{ form.task_due_time.help_text }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            {{ form.location }}
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="bg-primary hover:bg-secondary text-white font-medium py-2 px-4 border-2 border-primary transition-all duration-200 tracking-wide">
                        Save Entry
                    </button>
                    <button type="button" onclick="closeAddEntryModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 border-2 border-gray-300 transition-all duration-200 tracking-wide">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div id="addNoteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center" onclick="closeAddNoteModal()">
    <div class="bg-white border-2 border-green-600 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="border-b-2 border-green-600 bg-green-50 px-4 py-3">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-medium text-green-700">Add New Note</h2>
                <button onclick="closeAddNoteModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-4">
            <form method="post" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="add_note" value="1">
                
                <div>
                    <label for="{{ note_form.child.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Child</label>
                    {{ note_form.child }}
                </div>
                
                <div>
                    <label for="{{ note_form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    {{ note_form.title }}
                </div>
                
                <div>
                    <label for="{{ note_form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Category (Optional)</label>
                    {{ note_form.category }}
                </div>
                
                <div>
                    <label for="{{ note_form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                    {{ note_form.description }}
                </div>
                
                {{ note_form.entry_type }}
                
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 border-2 border-green-600 transition-all duration-200 tracking-wide">
                        Save Note
                    </button>
                    <button type="button" onclick="closeAddNoteModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 border-2 border-gray-300 transition-all duration-200 tracking-wide">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Child Modal -->
<div id="editChildModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center" onclick="closeEditChildModal()">
    <div class="bg-white border-2 border-secondary w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="border-b-2 border-secondary bg-purple-50 px-4 py-3">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-medium text-gray-900">Edit Child</h2>
                <button onclick="closeEditChildModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4">
            <form id="editChildForm" method="post" class="space-y-4">
                {% csrf_token %}
                
                <div>
                    <label for="edit_child_name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="edit_child_name" name="name" 
                           class="w-full px-3 py-2 border-2 border-gray-300 focus:border-secondary focus:outline-none">
                </div>
                
                <div>
                    <label for="edit_child_birth_date" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input type="date" id="edit_child_birth_date" name="birth_date" 
                           class="w-full px-3 py-2 border-2 border-gray-300 focus:border-secondary focus:outline-none">
                </div>
                
                <div>
                    <label for="edit_child_school" class="block text-sm font-medium text-gray-700 mb-1">School</label>
                    <input type="text" id="edit_child_school" name="school" 
                           class="w-full px-3 py-2 border-2 border-gray-300 focus:border-secondary focus:outline-none">
                </div>
                
                <div>
                    <label for="edit_child_year" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                    <input type="text" id="edit_child_year" name="year" 
                           class="w-full px-3 py-2 border-2 border-gray-300 focus:border-secondary focus:outline-none">
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="submit" class="w-full inline-flex justify-center border-2 border-primary bg-primary px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm">
                    Update Child
                </button>
                <button type="button" onclick="closeEditChildModal()" class="mt-3 w-full inline-flex justify-center border-2 border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
